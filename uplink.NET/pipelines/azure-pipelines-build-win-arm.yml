# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: 'ubuntu-20.04'

steps:
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: 'specific'
    project: '9ac1e3a1-e687-4aa6-ab2b-0108d21425e2'
    definition: '31'
    specificBuildWithTriggering: true
    buildVersionToDownload: 'latest'
    itemPattern: |
      **
      !*.cs
      !*.dll
      !win-x86-dll
      !win-x64-dll
      !Csharp-files
    targetPath: '$(System.DefaultWorkingDirectory)'
  displayName: 'Get build-artifacts'

- script: |
    ls
    ls uplink-c
    #rm uplink-c/util.go
    rm uplink-c/upload.go
    #rm uplink-c/scope.go
    rm uplink-c/restrict_scope_helper.go
    #rm uplink-c/project.go
    rm uplink-c/objects.go
    rm uplink-c/object.go
    rm uplink-c/multipart.go
    #rm uplink-c/handles_test.go
    #rm uplink-c/handles.go
    #rm uplink-c/error.go
    #rm uplink-c/encryption.go
    rm uplink-c/edge_share.go
    rm uplink-c/edge_access.go
    rm uplink-c/download.go
    #rm uplink-c/custommetadata_test.go
    #rm uplink-c/custommetadata.go
    rm uplink-c/custom_metadata_helper.go
    #rm uplink-c/config.go
    rm uplink-c/buckets.go
    rm uplink-c/bucket.go
    #rm uplink-c/access.go
    
    #sed -i uplink-c/scope.go -re '21,25d'
    #sed -i uplink-c/scope.go -re '9,9d'
    
    
    #Remove freeProject-call from uplink_free_project_result
    #sed -i uplink-c/project.go -re '71,71d'
    #sed -i uplink-c/project.go -re '87,88d'
    #sed -i uplink-c/project.go -re '82,82d'
    #sed -i '81s/.*/proj, ok := universe.Get(project._handle).(*Project)/' uplink-c/project.go
    
    #Remove uplink_close_project und uplink_open_project [rootScope]
    #sed -i uplink-c/project.go -re '20,65d'
    sed '10 a "github.com\/zeebo\/errs"' uplink-c/project.go
    sed '10 a "golang.org\/x\/sync\/errgroup"' uplink-c/project.go
    sed '10 a "storj.io\/common\/memory"' uplink-c/project.go
    sed '10 a "storj.io\/common\/rpc"' uplink-c/project.go
    sed '10 a "storj.io\/common\/storj"' uplink-c/project.go
    sed '10 a "storj.io\/uplink\/internal\/telemetryclient"' uplink-c/project.go
    sed '10 a "storj.ioÃŸ/uplink\/private\/ecclient"' uplink-c/project.go
    sed '10 a "storj.io\/uplink\/private\/metaclient"' uplink-c/project.go
    sed '10 a "storj.io\/uplink\/private\/storage/streams"' uplink-c/project.go
    sed '10 a "storj.io\/uplink\/private\/testuplink"' uplink-c/project.go
    sed '10 a "storj.io\/uplink\/private\/version"' uplink-c/project.go
    #sed -i '10s/.*/_ "golang.org\/x\/sync\/errgroup"/' uplink-c/project.go
    #sed -i '12s/.*/"fmt"/' uplink-c/project.go
    #sed -i '13s/.*/)/' uplink-c/project.go
    
    #sed -i '23s/.*/dialer := rpc.Dialer/' uplink-c/project.go
    #sed -i '24s/.*/if rpc != nil {/' uplink-c/project.go
    #sed -i '25s/.*/return C.UplinkProjectResult{/' uplink-c/project.go
    #sed -i '26s/.*/error: mallocError(ErrNull.New("access")),/' uplink-c/project.go
    #sed -i '27s/.*/}/' uplink-c/project.go
    #sed -i '28s/.*/}/' uplink-c/project.go
    #sed -i '29s/.*/return C.UplinkProjectResult{/' uplink-c/project.go
    #sed -i '30s/.*/error: mallocError(ErrNull.New("access")),/' uplink-c/project.go
    #sed -i '31s/.*/}/' uplink-c/project.go
    #sed -i uplink-c/project.go -re '20,65d'
    
    #Remove uplink_request_access_with_passphrase and "context"
    sed -i uplink-c/access.go -re '37,67d'
    sed -i uplink-c/access.go -re '9,9d'

    #Remove uplink_config_open_project [rootScope]
    sed -i uplink-c/config.go -re '50,79d'
    
    #uplink_config_request_access_with_passphrase and "context"
    sed -i uplink-c/config.go -re '15,48d'
    sed -i uplink-c/config.go -re '9,9d'

    echo "*** hier kommt die Maus ***"
    cat uplink-c/project.go
    echo "*** deleted ***"
    ls uplink-c
    #mv storj_uplink_second_wrap/storj_uplink_second_wrap.c uplink-c/storj_uplink_second_wrap.c
  displayName: 'Prepare for Target ARM'



- script: |
    echo "clone go"
    git clone https://go.googlesource.com/go
    cd go
    echo "get patch"
    git fetch https://go.googlesource.com/go refs/changes/89/321789/6 && git cherry-pick FETCH_HEAD
    cd src
    echo "build go"
    ./all.bash

    sudo snap install zig --classic --edge
    zig version
  displayName: 'Install Zig'

- script: |
    cd uplink-c
    #go get -u golang.org/x/sys
    #echo "*** make symlink"
    #mkdir math
    #cp -r -a /snap/zig/3678/lib/libc/mingw/math/. ./math/
    #echo "** listing math"
    #ls ./math
    #cd math
    #sudo wget https://raw.githubusercontent.com/ziglang/zig/de04ee9213f284cc277d35a409b7f821fb09b456/lib/libc/mingw/math/bsd_private_base.h
    #cd ..
    #sudo mount --bind -o nodev,ro $(pwd)/math /snap/zig/3678/lib/libc/mingw/math
    #echo "*** make symlink done"
    export PATH=$PATH:$(pwd)
    echo "Kann ersetzt werden durch 'zig cc'"
    echo $'#!/bin/sh \n zig cc -target aarch64-windows-gnu -mtune=cortex-a75 -mcpu=cortex_a75 -fno-sanitize-trap=undefined -fno-sanitize=undefined -v $@' >> zcc
    sudo chmod +x zcc
    echo $'#!/bin/sh \n zig c++ -target aarch64-windows-gnu -mtune=cortex-a75 -mcpu=cortex_a75 -fno-sanitize-trap=undefined -fno-sanitize=undefined -v $@' >> zxx
    sudo chmod +x zxx
    echo $'#!/bin/sh \n zig ar -v $@' >> zar
    sudo chmod +x zar
    export CC="zcc"
    export CXX="zxx"
    export AR="zar"
    export GOOS="windows"
    export GOARCH="arm64"
    export GOARM=7
    export CGO_ENABLED="1"
    #export GODEBUG=inittrace=1
    echo "listing deps"
    go list -deps
    echo "done listing deps"
    /go/bin/go build -ldflags="-s -w" -gcflags="-dwarflocationlists=true" -gcflags=all="-N -l" -o storj_uplink.dll -buildmode c-shared -tags extended -v
    echo "Build succeeded"
    ls -al
    echo "*** Hole pdb"
    cd ..
    find /home/vsts/ -type f | grep -i pdb$ | xargs -i cp {} uplink-c
  displayName: 'Test-Generate Win-ARM'

- task: PublishPipelineArtifact@1
  inputs:
      targetPath: 'uplink-c/storj_uplink.dll'
      artifact: 'arm64_dll'
      publishLocation: 'pipeline'
  displayName: 'Publish DLL as Artifact'

- task: PublishPipelineArtifact@1
  inputs:
      targetPath: 'uplink-c/storj_uplink.pdb'
      artifact: 'arm64_dll_pdb'
      publishLocation: 'pipeline'
  displayName: 'Publish PDB as Artifact'