# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: 'ubuntu-20.04'

steps:
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: 'specific'
    project: '9ac1e3a1-e687-4aa6-ab2b-0108d21425e2'
    definition: '31'
    specificBuildWithTriggering: true
    buildVersionToDownload: 'latest'
    itemPattern: |
      **
      !*.cs
      !*.dll
      !win-x86-dll
      !win-x64-dll
      !Csharp-files
    targetPath: '$(System.DefaultWorkingDirectory)'
  displayName: 'Get build-artifacts'

- script: |
    ls
    ls uplink-c
    mv storj_uplink_second_wrap/storj_uplink_second_wrap.c uplink-c/storj_uplink_second_wrap.c
  displayName: 'Prepare for Target ARM'

- task: GoTool@0
  inputs:
    version: '$(GOLANG_VERSION)'
  displayName: 'Install Go $(GOLANG_VERSION)'

- script: |
    go get -v golang.org/dl/go1.17rc2
    /home/vsts/go/bin/go1.17rc2 download
    /home/vsts/go/bin/go1.17rc2 version
  displayName: 'Run SWIG to generate a c-file necessary for the DLL'

#- script: |
#    wget https://developer.arm.com/-/media/Files/downloads/gnu-a/10.3-2021.07/binrel/gcc-arm-10.3-2021.07-x86_64-aarch64-none-elf.tar.xz
#    tar -xf gcc-arm-10.3-2021.07-x86_64-aarch64-none-elf.tar.xz
#    cd gcc-arm-10.3-2021.07-x86_64-aarch64-none-elf
#    cd bin
#    export PATH=$PATH:$(pwd)
#    cd ..
#    cd ..
#    cd uplink-c
#    #export CC="aarch64-none-elf-gcc"
#    #export CXX="aarch64-none-elf-g++"
#    export GOOS="windows"
#    export GOARCH="arm64"
#    export GOARM=7
#    export CGO_ENABLED="1"
#    /home/vsts/go/bin/go1.17rc2 build -ldflags="-s -w" -o storj_uplink.dll -buildmode c-shared
#    echo "Sollte dll enthalten:"
#    ls -al
#  displayName: 'Test-Generate Win-ARM with ARM'

#- script: |
#    wget https://github.com/mstorsjo/llvm-mingw/releases/download/20210423/llvm-mingw-20210423-ucrt-ubuntu-18.04-x86_64.tar.xz
#    tar -xf llvm-mingw-20210423-ucrt-ubuntu-18.04-x86_64.tar.xz
#    cd llvm-mingw-20210423-ucrt-ubuntu-18.04-x86_64
#    cd bin
#    export PATH=$PATH:$(pwd)
#    cd ..
#    cd ..
#    cd uplink-c
#    
#    export CC="aarch64-w64-mingw32-gcc -v"
#    export CXX="aarch64-w64-mingw32-g++ -v"
#    export GOOS="windows"
#    export GOARCH="arm64"
#    export GOARM=7
#    export CGO_ENABLED="1"
#    /home/vsts/go/bin/go1.17rc2 build -ldflags="-s -w" -o storj_uplink.dll -buildmode c-shared -tags extended -v
#    echo "Sollte DLL enthalten:"
#    ls -al

#    export CC="aarch64-w64-mingw32uwp-gcc"
#    export CXX="aarch64-w64-mingw32uwp-g++"
#    export GOOS="windows"
#    export GOARCH="arm64"
#    export GOARM=7
#    export CGO_ENABLED="1"
#    /home/vsts/go/bin/go1.17rc2 build -ldflags="-s -w -v" -o storj_uplinkuwp.dll -buildmode c-shared -tags extended -v
#    echo "Sollte DLL enthalten:"
#    ls -al
#  displayName: 'Test-Generate Win-ARM with LLVM'

- script: |
    sudo apt-get update
    sudo snap install zig --classic --beta
    zig version
    echo "*** realpath"
    realpath /snap/zig/3678/lib/libc/mingw/math/
    realpath /snap/zig/3678/lib/libc/mingw/math/cephes_emath.c
    echo "*** ll"
    ll /snap/zig/3678/lib/libc/mingw/math/
    ll /snap/zig/3678/lib/libc/mingw/math/cephes_emath.c
    cd /snap/zig/3678/lib/libc/mingw/math/
    ls
    sudo wget https://raw.githubusercontent.com/ziglang/zig/de04ee9213f284cc277d35a409b7f821fb09b456/lib/libc/mingw/math/bsd_private_base.h
    echo "downloaded"
    ls
    echo "done"
  displayName: 'Install cross compiler for Windows'

- script: |
    cd uplink-c
    sudo wget https://raw.githubusercontent.com/ziglang/zig/de04ee9213f284cc277d35a409b7f821fb09b456/lib/libc/mingw/math/bsd_private_base.h
    echo "*** make symlink"
    mkdir math
    cp -r /snap/zig/3678/lib/libc/mingw/math ./math
    sudo mount --bind -o nodev,ro $(pwd)/math /snap/zig/3678/lib/libc/mingw/math
    echo "*** make symlink done"
    export PATH=$PATH:$(pwd)
    echo "Kann ersetzt werden durch 'zig cc'"
    echo $'#!/bin/sh \n zig cc -target aarch64-windows-gnu -v $@' >> zcc
    sudo chmod +x zcc
    echo $'#!/bin/sh \n zig c++ -target aarch64-windows-gnu -v $@' >> zxx
    sudo chmod +x zxx
    echo $'#!/bin/sh \n zig ar -v $@' >> zar
    sudo chmod +x zar
    export CC="zcc"
    export CXX="zxx"
    export AR="zar"
    export GOOS="windows"
    export GOARCH="arm64"
    export GOARM=7
    export CGO_ENABLED="1"
    /home/vsts/go/bin/go1.17rc2 build -ldflags="-s -w" -o storj_uplink.dll -buildmode c-shared -tags extended -v
    echo "Build succeeded"
    ls -al
  displayName: 'Test-Generate Win-ARM'
